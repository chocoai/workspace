<!DOCTYPE HTML>
<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="keywords" content="${content.tagStr!}" />
<meta http-equiv="description" content="${content.description!}" />
<title>评论页 - ${site.name}</title>

<link rel="stylesheet" type="text/css" href="/${res}/css/global.css" />
<link rel="stylesheet" type="text/css" href="/${res}/css/public_all.css" />
<link rel="stylesheet" type="text/css" href="/${res}/css/index_con.css" />

<script type="text/javascript" src="/${res}/js/dc/settitle.js"></script>

<script type="text/javascript" src="${resSys}/jquery.js"></script>
<script type="text/javascript" src="${resSys}/front.js"></script>
<script type="text/javascript" src="/${res}/js/common.js"></script>
<script type="text/javascript" src="/${res}/js/layer/layer.js"></script>

<script type="text/javascript" src="/${res}/js/face/jquery-1.8.0.min.js"></script> 
<link href="/${res}/js/face/jquery.sinaEmotion.css" rel="stylesheet" type="text/css"/>
<script src="/${res}/js/face/jquery.sinaEmotion.js" type="text/javascript"></script>
<script type="text/javascript">

	$(function() {
		Cms.attachment("${base}", "${content.id}", "${content.attachments?size}", "attach");
		Cms.viewCount("${base}", "${content.id}");
		Cms.siteFlow("${base}", location.href, document.referrer);
	});
	
	function showList(id, text) {
		//iframe层
		layer.open({
			type: 2,
			title: "回复" + text,
			shadeClose: true,
			shade: 0.8,
			area: ['780px', '80%'],
			content: '${base}/comment_list.jspx?commentId=' + id //iframe的url
		});
	}
	
	function showReply(obj) {
		// 绑定表情
		$('#face' + obj).SinaEmotion($("#re_content" + obj));
		if (document.getElementById("reply" + obj).style.display == "none") {
			$('div[id=reply' + obj + '][title=]').show();
		} else {
			$('div[id=reply' + obj + '][title=]').hide();
		}
	
		$('div[id!=reply' + obj + '][title=]').hide();
	}
	
	function addReply(pid) {
		[#if user??]
		var text = $("#re_content" + pid).val();
		if (text == '') {
			alert('请输入回复内容！');
			$("#re_content" + pid).focus();
			return;
		}
		$("#content" + pid).val(AnalyticEmotion(text));
		var content = $("#content" + pid).val();
		$.ajax({
			url: "${base}/comment_reply.jspx",
			type: "post",
			data: "pid=" + pid + "&text=" + content + "&contentId=" + ${content.id},
			dataType: 'json',
			success: function(data) {
				if (data.status == 0) {
					alert("评论成功");
					location.href = location.href;
				} else {
					alert("评论失败");
				}
			}
		});
	[#else]window.location.href="${base}/login.jspx?returnUrl=${content.url}";
	[/#if]
	}
	/**
	 * 点赞
	 * @param id
	 * @return
	 */
	function addUPs(id) {
	
		$.ajax({
			type: "post",
			url: "${base}/comment_up.jspx?commentId=" + id,
			asyn: true, //false为同步提交
			dataType: 'text', //返回文本
			success: function(d) {
				//支持+1
				var ups = $('#ups_' + id).html();
				$('#agree' + id).removeClass("zan").addClass("support");
				$('#agree' + id).html('赞（' + parseInt(parseInt(ups) + 1) + '）');
				//点击失效
				$('#agree' + id).attr("onclick", "").click(function() {
	
				});
	
			}
		});
	}

</script>

</head>
<body>
	
	[#include "../include/header.html"/] 
	[#include "../include/navi.html"/]
	<div style="clear: both;"></div>
	<!--内容 开始-->
	<div class="content">
		<div class="box mt10">
			<div class="map">
				<img src="/${res}/images/home.png" width="20" height="18">
				<a href="${base}/">首页</a>
				>
				<a href="${content.url}">${content.title}</a>
				> 评论列表
			</div>

			<div class="details">

				<div class="details_left">
					<div style="clear: both;"></div>
					<div class="send_mess">我要评论</div>
					[#include "../content/inc_comment_input.html"/]

					<div style="clear: both;"></div>
					<div class="send_mess">
						全部评论（
						<span id="comments"></span>
						）
					</div>
					<div class="review_all">
			
						<ul id="con_order_1">
							[@cms_comment_page contentId=content.id count='10' ] 
							[#if tag_pagination.list?size = 0]
							<li>
								暂无评论！
								</span>
							</li>
							[#else] 
							[#list tag_pagination.list as c]
							<input type="hidden" id="content${c.id}" name="text" />
							<li>
								<div class="review_all_l">
									<a href="#">
									[#if c.user??]
	          	   	                   [#if c.user.userImg??]<img src="${c.user.userImg!}" width="60" height="60"/>
	                                   [#else]<img src="/${res}/images/people.png" width="60" height="60"/>
                                       [/#if]
                                    [#else]<img src="/${res}/images/people.png" width="60" height="60"/>
                                    [/#if]
									</a>
								</div>
								<div class="review_all_r">

									<div class="reviewer">
										<span>${(c.commentUser.username)!"匿名网友"}</span>
										<u>${c.createTime!string("yyyy-MM-dd HH:mm")}</u>
									</div>

									<div class="review_cont">${c.text!}</div>

									<ul class="reply">
										<li class="zan" onclick="addUPs(${c.id})" id="agree${c.id}">
											赞（
											<span id="ups_${c.id}">${c.ups}</span>
											）
											</span>
										</li>
										<li class="reversion" onclick="showReply('${c.id}')">回复</li>
										[@cms_comment_list parentId= c.id] 
										[#if tag_list?size gt 0]
										<li class="search_reply" onclick="showList('${c.id}','${(c.commentUser.username)!}:${c.textHtml!}')">${tag_list?size}条回复</li>
										[/#if] 
										[/@cms_comment_list]
									</ul>

									<div id="reply${c.id}" title="" class="send_mess_box2" style="display: none">
										<textarea id="re_content${c.id}" name="kcontent"></textarea>
										<span id="face${c.id}">
											<img src="/${res}/images/icon_biaoqing.png" alt="" />
										</span> 
										<div class="send_butt">
											<a href="javascript:addReply('${c.id}');">确认</a>
										</div>
									</div>
								</div>
							</li>
							[/#list]
							<div style="clear: both;"></div>
							<div class="list_dis">
								<div class="jogger">[@cms_pagination sysPage='1'/]</div>
							</div>
							[/#if] 
							[/@cms_comment_page]

						</ul>
					

					</div>
				</div>

				[#include "../include/right.html"/]

			</div>
		</div>
	</div>
	<!--内容 end-->
	[#include "../include/footer.html"/]
</body>
</html>