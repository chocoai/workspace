package com.yhcrt.shiro.filter;


import static com.yhcrt.utils.Constants.LOGIN_USER;

import javax.annotation.Resource;
import javax.servlet.ServletRequest;
import javax.servlet.ServletResponse;

import org.apache.shiro.SecurityUtils;
import org.apache.shiro.web.filter.AccessControlFilter;

import com.yhcrt.entity.system.SysMuserInfo;
import com.yhcrt.entity.system.SysUser;
import com.yhcrt.service.stsyem.SysMuserInfoService;
import com.yhcrt.shiro.TokenManager.TokenManager;

/**
 * 
 * 判断登录
 * 
 */
public class LoginFilter  extends AccessControlFilter {
	
	@Resource(name="sysMuserInfoService")
	private SysMuserInfoService sysMuserInfoService;
	
	final static Class<LoginFilter> CLASS = LoginFilter.class;
	@Override
	protected boolean isAccessAllowed(ServletRequest request,
			ServletResponse response, Object mappedValue) throws Exception {
		
		SysUser sysUser = (SysUser) SecurityUtils.getSubject().getPrincipal();
		
		
		if(null != sysUser || isLoginRequest(request, response)){// && isEnabled()
			SysMuserInfo muserInfo =(SysMuserInfo) TokenManager.getVal2Session(LOGIN_USER);
			if(muserInfo==null){
				SysMuserInfo sysMuserInfo = sysMuserInfoService.findByUserId(sysUser.getCid());
				TokenManager.setVal2Session(LOGIN_USER,sysMuserInfo);
			}
            return Boolean.TRUE;
        }
		return Boolean.FALSE ;
	}

	@Override
	protected boolean onAccessDenied(ServletRequest request, ServletResponse response)
			throws Exception {
		//保存Request和Response 到登录后的链接
		saveRequestAndRedirectToLogin(request, response);
		return Boolean.FALSE ;
	}
	

}
