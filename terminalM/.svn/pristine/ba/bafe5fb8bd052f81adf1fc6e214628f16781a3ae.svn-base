<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.whty.assis.mall.dao.AppInfoDao">

	<resultMap type="com.whty.assis.mall.model.AppInfo" id="AppInfoResult">
		<result property="id" column="id" />
		<result property="creator" column="creator" />
		<result property="description" column="description" />
		<result property="company" column="company" />
		<result property="icon" column="icon" />
		<result property="md5" column="md5" />
		<result property="classify" column="classify" />
		<result property="createTime" column="create_time" />
		<result property="updateTime" column="update_time" />
		<result property="version" column="version" />
		<result property="fileSize" column="file_size" />
		<result property="creatorName" column="creator_name" />
		<result property="downUrl" column="down_url" />
		<result property="versionCode" column="version_code" />
		<result property="packageName" column="package_name" />
		<result property="bosStatus" column="bos_status" />
		
		<result property="pushDeviceNum" column="push_device_num" />
		
		
	</resultMap>
	
	<select id="loadById" parameterType="int" resultMap="AppInfoResult">
		select t1.*,t4.user_name as creator_name 
			from t_app_info t1 left join ta_manage_user_info t4 on t1.creator=t4.id
			  where 1=1 and t1.id = #{_parameter}
	</select>
	
	<delete id="deleteAppGradeByAppId" parameterType="int">
		delete from t_app_grade where app_id=#{_parameter}
	</delete>
	
	<delete id="deleteAppSubjectByAppId" parameterType="int">
		delete from t_app_subject where app_id=#{_parameter}
	</delete>
	
	<delete id="deleteById" parameterType="int">
		delete from t_app_info where id=#{_parameter}
	</delete>
	
	<insert id="save" parameterType="com.whty.assis.mall.model.AppInfo">
		insert into t_app_info(
			name,
			creator,
			create_time,
			update_time,
			icon,
			md5,
			version,
			version_code,
			package_name,
			file_size,
			company,
			down_url,
			bos_status,
			<if test="description != null and description != ''">description,</if>
			classify
			) values (
				#{name},
				#{creator},
				#{createTime},
				#{updateTime},
				#{icon},
				#{md5},
				#{version},
				#{versionCode},
				#{packageName},
				#{fileSize},
				#{company},
				#{downUrl},
				#{bosStatus},
				<if test="description != null and description != ''">#{description},</if>
				#{classify}
			)
	</insert>
	
	
	<insert id="saveAppGrade" parameterType="com.whty.assis.mall.model.AppGrade">
		insert into t_app_grade(
			app_id,
			grade_id
			) values (
				#{appId},
				#{gradeId}
			)
	</insert>
	
	<insert id="saveAppSubject" parameterType="com.whty.assis.mall.model.AppSubject">
		insert into t_app_subject(
			app_id,
			subject_id
			) values (
				#{appId},
				#{subjectId}
			)
	</insert>
	 
	
	<select id="listByParam" parameterType="map" resultMap="AppInfoResult">
		select t1.*,t4.user_name as creator_name 
			from t_app_info t1 left join ta_manage_user_info t4 on t1.creator=t4.id
			  where 1=1
		<if test="appName != null and appName != '' ">and t1.name like CONCAT(#{appName},'%')</if>
		<if test="md5 != null and md5 != '' ">and t1.md5 = #{md5} </if>
		<if test="gradeIds != null">
			and t1.id in (select app_id from t_app_grade where grade_id in
			<foreach collection="gradeIds" index="index" item="item" open="(" close=")" separator=",">
				 #{item}
			</foreach>)
		</if>
	
		<if test="subjectIds != null">
			and t1.id in (select app_id from t_app_subject where subject_id in
			<foreach collection="subjectIds" index="index" item="item" open="(" close=")" separator=",">     
				  #{item}
			</foreach>
			)
		</if>
		order by t1.create_time desc
	</select> 
	 
	<select id="listByCondition" parameterType="map" resultMap="AppInfoResult">
		select t1.*,t4.user_name as creator_name,
(select count(*) from
(select app_push_log.device_id,app_push.app_id from t_app_push app_push 
left join t_app_push_log app_push_log on app_push.id=app_push_log.app_push_id 
 group by app_push_log.device_id) tt where tt.app_id=t1.id) as push_device_num
  from 
( select * from t_app_info  order by version_code desc) t1 left join ta_manage_user_info t4 on t1.creator=t4.id
			  where 1=1
		<if test="appName != null and appName != '' ">and t1.name like CONCAT(#{appName},'%')</if>
		<if test="md5 != null and md5 != '' ">and t1.md5 = #{md5} </if>
		<if test="gradeIds != null">
			and t1.id in (select app_id from t_app_grade where grade_id in
			<foreach collection="gradeIds" index="index" item="item" open="(" close=")" separator=",">
				 #{item}
			</foreach>)
		</if>
	
		<if test="subjectIds != null">
			and t1.id in (select app_id from t_app_subject where subject_id in
			<foreach collection="subjectIds" index="index" item="item" open="(" close=")" separator=",">     
				  #{item}
			</foreach>
			)
		</if>
		 group by t1.name 
		order by t1.create_time desc
	</select>
	
	<update id="update" parameterType="com.whty.assis.mall.model.AppInfo">
		update t_app_info
		set 
		<trim prefixOverrides=",">
			<if test="updateTime != null ">, update_time=#{updateTime}</if>
			<if test="bosStatus != null ">, bos_status=#{bosStatus}</if>
			<if test="company != null ">, company=#{company}</if>
			<if test="packageName != null ">, package_name=#{packageName}</if>
			<if test="downUrl != null and downUrl !='' ">, down_url=#{downUrl}</if>
			<if test="name != null and name != ''">, name=#{name}</if>
			<if test="description != null and description != ''">, description=#{description}</if>
		</trim>
		where id=#{id}
	</update>
	
	
</mapper>
