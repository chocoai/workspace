<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.whty.assis.basicdata.dao.OrderDao">

	<!-- 这里的Demo是别名，需要在mybatis-config.xml中定义，或者写类全名 -->
	<resultMap type="com.whty.assis.basicdata.model.Order" id="OrderResult">
		<id property="id" column="id" />
		<result property="name" column="name" />
		<result property="creator"     column="creator" />
		<result property="creatorName" column="creator_name" />
		<result property="createTime" column="create_time" />
		<result property="updateTime" column="update_time" />
		<result property="provinceName" column="province_name" />
		<result property="areaName" column="area_name" />
		<result property="cityName" column="city_name" />
		<result property="provinceCode" column="province_code" />
		<result property="areaCode" column="area_code" />
		<result property="cityCode" column="city_code" />
		<result property="supplierId" column="supplier_id" />
		<result property="supplierName" column="supplier_name" />
		<result property="contractNumber" column="contract_number" />
		<result property="orderNumber" column="order_number" />
		<result property="orderTime" column="order_time" />
		<result property="deviceNum" column="device_num" />
		<result property="carryNum" column="carry_num" />
		<result property="status" column="status" />
	</resultMap>
	
	<delete id="deleteById" parameterType="int">
		delete from t_order where id= #{_parameter}
	</delete>
	
	<update id="update" parameterType="com.whty.assis.basicdata.model.Order">
		update t_order 
		set 
		<trim prefixOverrides=",">
			<if test="status != null and status != ''">, status=#{status}</if>
			<if test="updateTime != null">, update_time=#{updateTime}</if>
		</trim>
		where id=#{id}
	</update>
	
	<insert id="save" parameterType="com.whty.assis.basicdata.model.Order">
		insert into t_order (
			id
			,order_number
			,order_time
			,order_type
			,supplier_id
			,contract_number
			,creator
			,status
			<if test="memo != null and memo != ''">,memo</if>
			<if test="provinceCode != null and provinceCode != ''">,province_code</if>
			<if test="cityCode != null and cityCode != ''">,city_code</if>
			<if test="areaCode != null and areaCode != ''">,area_code</if>
			,create_time
			,update_time
		) values (
			#{id}
			,#{orderNumber}
			,#{orderTime}
			,#{orderType}
			,#{supplierId}
			,#{contractNumber}
			,#{creator}
			,#{status}
			<if test="memo != null and memo != ''">,#{memo}</if>
			<if test="provinceCode != null and provinceCode != ''">,#{provinceCode}</if>
			<if test="cityCode != null and cityCode != ''">,#{cityCode}</if>
			<if test="areaCode != null and areaCode != '' ">,#{areaCode}</if>
			,#{createTime}
			,#{updateTime}
		)
	</insert>
	
	
	<insert id="saveTerminalDeviceType" parameterType="com.whty.assis.basicdata.model.OrderTerminalDeviceType">
		insert into t_order_terminal_device_type (
			id
			,order_id
			,terminal_device_type_id
			,quan
			,create_time
			,update_time
		) values (
			#{id}
			,#{orderId}
			,#{terminalDeviceTypeId}
			,#{quan}
			,#{createTime}
			,#{updateTime}
		)
	</insert>
	
	
	<select id="listByCondition" parameterType="map" resultMap="OrderResult">
		select (select count(*) from t_device_info where order_id=t1.id) as device_num,(select count(*) from t_device_info where order_id=t1.id and device_status = 2) as carry_num,t1.*,t2.area_name as province_name,t3.area_name as city_name,t4.area_name as area_name,t5.name as supplierInfo_name,t6.user_name as creator_name from 
t_order t1 left join ta_area t2 on t1.province_code = t2.area_code left join ta_area t3 on t1.city_code=t3.area_code
left join ta_area t4 on t1.area_code = t4.area_code  left join t_supplier_info t5 on t1.supplier_id = t5.id left join ta_manage_user_info t6
on t1.creator=t6.id
		where 1=1
		<if test="id != null ">and t1.id=#{id}</if>
		<if test="status != null ">and t1.status=#{status}</if>
		
		<if test="provinceCode != null and provinceCode != '' ">and t1.province_code=#{provinceCode}</if>
		<if test="cityCode != null and cityCode != '' ">and t1.city_code=#{cityCode}</if>
		<if test="areaCode != null and areaCode != '' ">and t1.area_code=#{areaCode}</if>
		
		<if test="supplierId != null ">and t1.supplier_id=#{supplierId}</if>
		<if test="orderNumber != null and orderNumber != '' ">and t1.order_number like CONCAT(#{orderNumber},'%')</if>
		<if test="contractNumber != null and contractNumber != '' ">and t1.contract_number like CONCAT(#{contractNumber},'%')</if>
		order by t1.create_time desc
	</select>
	
		
		<select id="getOrderById" parameterType="int" resultMap="OrderResult">
		select (select count(*) from t_device_info where order_id=t1.id) as device_num,(select count(*) from t_device_info where order_id=t1.id and school_id is not NULL) as carry_num,t1.*,t2.area_name as province_name,t3.area_name as city_name,t4.area_name as area_name,t5.name as supplierInfo_name,t6.user_name as creator_name from 
t_order t1 left join ta_area t2 on t1.province_code = t2.area_code left join ta_area t3 on t1.city_code=t3.area_code
left join ta_area t4 on t1.area_code = t4.area_code  left join t_supplier_info t5 on t1.supplier_id = t5.id left join ta_manage_user_info t6
on t1.creator=t6.id
		where 1=1
		and t1.id=#{id}
		</select>	
	
	
</mapper>