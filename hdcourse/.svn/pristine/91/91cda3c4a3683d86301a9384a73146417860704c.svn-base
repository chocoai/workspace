<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.whty.assis.demo.dao.CountWidgetDao">
	<resultMap type="com.whty.assis.demo.model.WidgetHistory" id="widgetHistoryResult">
		<id property="id" column="id" />
		<result property="useCount" column="use_count" />
		<result property="userCount" column="user_count" />
		<result property="userId" column="user_id" />
		<result property="orgId" column="org_Id" />
		<result property="platformCode" column="platform_code" />
		<result property="machineInfo" column="machine_info" />
		<result property="widgetId" column="widget_id" />
		<result property="memory" column="memory" />
		<result property="classId" column="class_id" />
		<result property="cpuInfo" column="cpu_info" />
		<result property="isTransfer" column="is_transfer" />
		<result property="createTime" column="create_time" />
		<result property="operationSystemInfo" column="operation_system_info" />
		<result property="operationSystemType" column="operation_system_type" />
		<result property="classType" column="class_type" />	
		<result property="orgName" column="org_name" />
		<result property="userName" column="user_name" />
		<result property="areaCode" column="area_code" />
		<result property="widgetName" column="widget_name"/>
		<result property="className" column="class_name"/>
		<result property="eventName" column="event_name"/>
		<result property="description" column="description"/>
		<result property="areaName" column="area_name"/>
		<result property="year" column="year"/>
		<result property="month" column="month"/>
	</resultMap>

	<resultMap type="java.util.HashMap" id="OrgResult">
		<result column="org_Id" property="orgId"/>
		<result column="org_name" property="orgName"/>
	</resultMap>
	
	<!-- 统计学校 -->
	<select id="getOrgListByAreaCode" parameterType="map" resultMap="OrgResult">
		select org_id,org_name from T_WIDGET_HISTORY 
		where area_code = #{areaCode} and org_name is not null 
		<if test="year != null">and year=#{year}</if>
		<if test="month != null">and month=#{month}</if>
		group by org_id,org_name 
		
	</select>
	
	<!-- 统计控件详细使用次数及使用人数 -->
	<select id="getWidget" parameterType="java.util.HashMap" resultMap="widgetHistoryResult">
		select event_id as widget_id,event_name,description,use_count,user_count from t_widget
		where 1=1
		<if test="class_name != null">and class_name=#{class_name}</if>
		<if test="year != null">and year=#{year}</if>
		<if test="month != null">and month=#{month}</if>
		<if test="areaCode != null">and area_Code=#{areaCode}</if>
		<if test="provinceCode != null">and area_code in(select area_code from TA_AREA where parent_id=#{provinceCode} and level_id='2')</if>
		<if test="startTime != null and startTime != ''"> and create_time>=date_format(#{startTime},'yyyy-mm-dd')</if>
		<if test="endTime != null and endTime != ''"><![CDATA[ and create_time<=date_format(#{endTime},'yyyy-mm-dd')]]></if>
	</select>
	
	<!-- 统计控件使用次数 -->
	<select id="getWidgetCount" parameterType="java.util.HashMap" resultMap="widgetHistoryResult">
		select class_name,sum(use_count) as use_count from t_widget
		where 1=1
		<if test="year != null">and year=#{year}</if>
		<if test="month != null">and month=#{month}</if>
		<if test="areaCode != null">and area_Code=#{areaCode}</if>
		<if test="provinceCode != null">and area_code in(select area_code from TA_AREA where parent_id=#{provinceCode} and level_id='2')</if>
		<if test="startTime != null and startTime != ''"> and create_time>=date_format(#{startTime},'yyyy-mm-dd')</if>
		<if test="endTime != null and endTime != ''"><![CDATA[ and create_time<=date_format(#{endTime},'yyyy-mm-dd')]]></if>
		group by class_name
	</select>
	
	<!-- 统计控件使用次数 -->
	<select id="getWidgetHistoryCount" parameterType="java.util.HashMap" resultMap="widgetHistoryResult">
		select t1.*,t2.WIDGET_NAME,t2.DESCRIPTION from  
		(select widget_id,sum(use_count) as use_count from T_WIDGET_HISTORY 
		where 1=1
		<if test="year != null">and year=#{year}</if>
		<if test="month != null">and month=#{month}</if>
		<if test="areaCode != null">and area_Code=#{areaCode}</if>
		<if test="provinceCode != null">and area_code in(select area_code from TA_AREA where parent_id=#{provinceCode} and level_id='2')</if>
		<if test="orgId != null">and org_id=#{orgId}</if>
		<if test="startTime != null and startTime != ''"> and create_time>=date_format(#{startTime},'yyyy-mm-dd')</if>
		<if test="endTime != null and endTime != ''"><![CDATA[ and create_time<=date_format(#{endTime},'yyyy-mm-dd')]]></if>
		group by widget_id) as t1 right join TA_WIDGET t2 on t1.widget_id=t2.id
	</select>
	
	<select id="getAllRanking"  resultMap="widgetHistoryResult" parameterType="java.util.HashMap">
		select t1.area_code,t2.area_name,t1.use_count from
		(select area_code,sum(use_count) as use_count from T_WIDGET_HISTORY  
		where area_code is not null and area_code !=''
		<if test="year != null">and year=#{year}</if>
		<if test="month != null">and month=#{month}</if>
		<if test="startTime != null and startTime != ''"> and date_format(create_time,'yyyy-mm-dd')>=#{startTime}</if>
		<if test="endTime != null and endTime != ''"><![CDATA[ and date_format(create_time,'yyyy-mm-dd')<=#{endTime}]]></if>
		group by area_code) t1 left join TA_AREA t2 on t1.area_code = t2.area_code where t2.area_code is not null
	</select>
	
	<select id="getUserRankingByOrg" resultMap="widgetHistoryResult" parameterType="string">
	select user_id,sum(use_count) as use_count,user_name as area_name from T_WIDGET_HISTORY 
	where org_id=#{orgId} and year=#{year} and month=#{month}
	<if test="startTime != null and startTime != ''"> and date_format(create_time,'yyyy-mm-dd')>=#{startTime}</if>
	<if test="endTime != null and endTime != ''"><![CDATA[ and date_format(create_time,'yyyy-mm-dd')<=#{endTime}]]></if>
	  group by user_id,user_name
	</select>
	
	<select id="getOrgRankingByAreaCode" resultMap="widgetHistoryResult" parameterType="string">
		select org_id,sum(use_count) as use_count,org_name as area_name from T_WIDGET_HISTORY 
		where area_code =#{cityCode} and year=#{year} and month=#{month}
		<if test="startTime != null and startTime != ''"> and date_format(create_time,'yyyy-mm-dd')>=#{startTime}</if>
		<if test="endTime != null and endTime != ''"><![CDATA[ and date_format(create_time,'yyyy-mm-dd')<=#{endTime}]]></if>
		group by org_id,org_name
	</select>
	
	<!-- 找到省份下的所有区域统计 -->
	<select id="getAreaCodeRankingByProvinceCode" resultMap="widgetHistoryResult" parameterType="java.util.HashMap">
		select t1.area_code,t2.area_name,t1.use_count from
		(select area_code,sum(use_count) as use_count from T_WIDGET_HISTORY where area_code in
		(select area_code from TA_AREA where parent_id=#{parentId} and level_id='2' and year=#{year} and month=#{month}) 
		<if test="startTime != null and startTime != ''"> and date_format(create_time,'yyyy-mm-dd')>=#{startTime}</if>
		<if test="endTime != null and endTime != ''"><![CDATA[ and date_format(create_time,'yyyy-mm-dd')<=#{endTime}]]></if>
		group by area_code) t1 left join TA_AREA t2 on t1.area_code = t2.area_code
	</select>
	
	<select id="getCountData" resultMap="widgetHistoryResult">
		select count(1) as use_count from 
		(select area_code from T_WIDGET_HISTORY 
		group by area_code) t1
		union
		select count(1) as use_count from 
		(select org_id from T_WIDGET_HISTORY 
		group by org_id) t2
		union
		select count(1) as use_count from 
		(select user_id from T_WIDGET_HISTORY 
		group by user_id) t3
	</select>
	
	<select id="getAreaCountData" resultMap="widgetHistoryResult" parameterType="map">
		select count(1) as use_count from 
		(select area_code from T_WIDGET_HISTORY 
		where 1=1
		<if test="provinceCode !=null and provinceCode !=''"> and area_code in(select area_code from TA_AREA where
			parent_id=#{provinceCode} and level_id='2')</if>
		<if test="year !=null"> and year=#{year}</if>
		<if test="month !=null"> and month=#{month}</if>
		group by area_code
		) t1
		union
		select sum(use_count) as use_count from T_WIDGET_HISTORY
		where 1=1
		<if test="provinceCode !=null and provinceCode !=''"> and area_code in(select area_code from TA_AREA where
			parent_id=#{provinceCode} and level_id='2')</if>
		<if test="year !=null"> and year=#{year}</if>
		<if test="month !=null"> and month=#{month}</if>
		union
		select count(1) as use_count from
		(select org_id from T_WIDGET_HISTORY 
		where 1=1
		<if test="provinceCode !=null and provinceCode !=''"> and area_code in(select area_code from TA_AREA where
			parent_id=#{provinceCode} and level_id='2')</if>
		<if test="year !=null"> and year=#{year}</if>
		<if test="month !=null"> and month=#{month}</if>
		group by org_id
		) t3
	</select>

</mapper>