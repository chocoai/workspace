<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.whty.assis.demo.dao.UseTakingCountDao">

	<resultMap type="com.whty.assis.demo.model.AreaMonthUseTakingCount"
		id="AreaMonthUseTakingCountResult">
		<result property="createTime" column="create_time" />
		<result property="areaCode" column="area_code" />
		<result property="areaName" column="area_name" />
		<result property="useTaking" column="use_taking" />
		<result property="previousUseTaking" column="previous_use_taking" />
		<result property="rate" column="rate" />
		<result property="updateTime" column="update_time" />
		<result property="year" column="year" />
		<result property="month" column="month" />
		<result property="platformCode" column="platform_code" />
		<result property="platformName" column="platform_name" />
		<result property="useCount" column="use_count" />
		
		
		<result property="orgNum" column="org_num" />
	</resultMap>

	<resultMap type="com.whty.assis.demo.model.OrgMonthUseTakingCount"
		id="OrgMonthUseTakingCountResult">
		<result property="orgId" column="org_id" />
		<result property="orgName" column="org_name" />
		<result property="createTime" column="create_time" />
		<result property="areaCode" column="area_code" />
		<result property="areaName" column="area_name" />
		<result property="rate" column="rate" />
		<result property="previousUseTaking" column="previous_use_taking" />
		<result property="useTaking" column="use_taking" />
		<result property="updateTime" column="update_time" />
		<result property="year" column="year" />
		<result property="month" column="month" />
		<result property="platformCode" column="platform_code" />
		<result property="platformName" column="platform_name" />
		<result property="useCount" column="use_count" />
		<result property="orgNum" column="org_num" />
	</resultMap>


	<resultMap type="com.whty.assis.demo.model.UserMonthUseTakingCount"
		id="UserMonthUseTakingCountResult">
		<result property="orgId" column="org_id" />
		<result property="orgName" column="org_name" />
		<result property="createTime" column="create_time" />
		<result property="areaCode" column="area_code" />
		<result property="areaName" column="area_name" />
		<result property="rate" column="rate" />
		<result property="previousUseTaking" column="previous_use_taking" />
		<result property="useTaking" column="use_taking" />
		<result property="updateTime" column="update_time" />
		<result property="year" column="year" />
		<result property="month" column="month" />
		<result property="platformCode" column="platform_code" />
		<result property="platformName" column="platform_name" />
		<result property="userId" column="user_id" />
		<result property="userName" column="user_name" />
		<result property="useCount" column="use_count" />
		<result property="orgNum" column="org_num" />
	</resultMap>


	<select id="getAreaUseTakingDataGroupByArea" parameterType="map"
		resultMap="AreaMonthUseTakingCountResult">
		select t1.area_code,t2.area_name,sum(use_taking) as
		use_taking,count(org_id) as org_num from TA_AREA_MONTH_USE_TAKING_COUNT
		t1 left join TA_AREA t2 on t1.area_code = t2.area_code
		where 1=1
		<if test="year !=null">and t1.year=#{year}</if>
		<if test="month !=null">and t1.month=#{month}</if>
		<if test="areaCode !=null and areaCode !=''">and t1.area_code = #{areaCode}</if>
		<if test="cityCode !=null and cityCode !=''">and t1.area_code = #{cityCode}</if>
		<if test="provinceCode !=null and provinceCode !=''"> and t1.area_code in(select area_code from TA_AREA where
			parent_id=#{provinceCode} and level_id='2')</if>
		group by t1.area_code,t2.area_name order by use_taking desc
	</select>

	<select id="getCountData" resultMap="AreaMonthUseTakingCountResult"
		parameterType="map">
		(select count(*) as use_Taking from
		(select count(*) from TA_AREA_MONTH_USE_TAKING_COUNT group by area_code) as
		t1)
		union all
		(select count(*) as use_Taking from
		(select count(*) from TA_ORG_MONTH_USE_TAKING_COUNT group by org_id) as t2)
		union all
		(select count(*) as use_Taking from
		(select count(*) from TA_USER_MONTH_USE_TAKING_COUNT group by user_id) as t3)
	</select>


	<select id="getAreaCountData" resultMap="AreaMonthUseTakingCountResult"
		parameterType="map">
		select count(*) as use_taking from
		(select count(*) as use_taking from TA_AREA_MONTH_USE_TAKING_COUNT where 1=1
		<if test="provinceCode !=null and provinceCode !=''"> and area_code in(select area_code from TA_AREA where
			parent_id=#{provinceCode} and level_id='2')</if>
		<if test="year !=null"> and year=#{year}</if>
		<if test="month !=null"> and month=#{month}</if>
		group by area_code) as t1
		union all
		select sum(use_taking) as use_taking from
		(select sum(use_taking) as use_taking from TA_AREA_MONTH_USE_TAKING_COUNT
		where 1=1
		<if test="provinceCode !=null and provinceCode !=''"> and area_code in(select area_code from TA_AREA where
			parent_id=#{provinceCode} and level_id='2')</if>
		<if test="year !=null"> and year=#{year}</if>
		<if test="month !=null"> and month=#{month}</if>
		group by area_code) as t2
		union all
		select count(*) as use_count from
		(select count(org_id) from TA_AREA_MONTH_USE_TAKING_COUNT where 1=1
		<if test="provinceCode !=null and provinceCode !=''"> and area_code in(select area_code from TA_AREA where
			parent_id=#{provinceCode} and level_id='2')</if>
		<if test="year !=null"> and year=#{year}</if>
		<if test="month !=null"> and month=#{month}</if>
		group by area_code,org_id) as t3
	</select>


	<select id="getAreaMonthUseTakingCountData" parameterType="map" resultMap="AreaMonthUseTakingCountResult">
		select sum(t1.use_taking) as use_taking,t1.area_code,t2.area_name
            from TA_AREA_MONTH_USE_TAKING_COUNT t1 left join TA_AREA t2 on t1.area_code = t2.area_code left join TA_BASE_PROPERTY t3 on t1.platform_code = t3.platform_code and t3.property_key='platform_url'
          where 1=1
			<if test="year != null ">and t1.year = #{year}</if>
			<if test="month != null">and t1.month = #{month}</if>
			<if test="platformCode != null">and t1.platform_code = #{platformCode}</if>
			<if test="areaid != null and areaid != ''">and t1.area_code like CONCAT(#{areaid},'%')</if>
			<if test="orgName !=null and orgName!=''">and t1.org_name like CONCAT('%',#{orgName},'%')</if>
			<if test="provinceCode !=null and provinceCode !=''"> and t1.area_code in(select area_code from TA_AREA where parent_id=#{provinceCode} and level_id='2')</if>
	 	group by t1.area_code,t2.area_name
	</select>



	<select id="getOrgUseTakingData" parameterType="map" resultMap="OrgMonthUseTakingCountResult">
	select count(*) as use_taking from
		    (select count(*) as use_taking from TA_ORG_MONTH_USE_TAKING_COUNT where 1=1 
		    <if test="provinceCode !=null and provinceCode !=''"> and area_code in(select area_code from TA_AREA where parent_id=#{provinceCode} and level_id='2')</if>
		    <if test="areaCode !=null and areaCode !=''"> and area_code=#{areaCode}</if>
		    <if test="year !=null"> and year=#{year}</if>
		    <if test="month !=null"> and month=#{month}</if>
		    <if test="orgName !=null and orgName!=''">and org_name like CONCAT('%',#{orgName},'%')</if>
		    group by org_id)  as t1
		union all 
			select sum(use_taking) as use_taking from
	    	(select sum(use_taking) as use_taking from TA_ORG_MONTH_USE_TAKING_COUNT where 1=1 
	   		<if test="provinceCode !=null and provinceCode !=''"> and area_code in(select area_code from TA_AREA where parent_id=#{provinceCode} and level_id='2')</if>
		    <if test="areaCode !=null and areaCode !=''"> and area_code=#{areaCode}</if>
		    <if test="year !=null"> and year=#{year}</if>
		    <if test="month !=null"> and month=#{month}</if>
		    <if test="orgName !=null and orgName!=''">and org_name like CONCAT('%',#{orgName},'%')</if>
	    	group by org_id)  as t2
	</select>


	<select id="getOrgUseTakingDataGroupByOrg" parameterType="map" resultMap="OrgMonthUseTakingCountResult">
	select t2.area_name,t1.area_code, t1.org_id,t1.org_name,sum(t1.use_taking) as use_taking from TA_ORG_MONTH_USE_TAKING_COUNT t1 left join TA_AREA t2 on t1.area_code = t2.area_code
	where 1=1 
	<if test="year !=null">and t1.year=#{year}</if>
	<if test="month !=null">and t1.month=#{month}</if>
	<if test="areaCode !=null and areaCode !=''">and t1.area_code = #{areaCode}</if>
	<if test="cityCode !=null and cityCode !=''">and t1.area_code = #{cityCode}</if>
	<if test="orgId !=null and orgId !=''">and t1.org_id = #{orgId}</if>
	<if test="provinceCode !=null and provinceCode !=''"> and t1.area_code in(select area_code from TA_AREA where parent_id=#{provinceCode} and level_id='2')</if>
	group by t1.org_id,t1.org_name,t1.area_code,t2.area_name order by use_taking desc
</select>

<select id="getOrgMonthUseTakingCountEcharts" parameterType="map" resultMap="OrgMonthUseTakingCountResult">
select t1.org_id,t1.org_name,sum(use_taking) as use_taking
    from TA_ORG_MONTH_USE_TAKING_COUNT t1 left join TA_AREA t2 on t1.area_code = t2.area_code left join TA_BASE_PROPERTY t3 on t1.platform_code = t3.platform_code and t3.property_key='platform_url'
    where 1=1
	<if test="orgId != null and orgId != ''">and t1.org_id=#{orgId}</if>
	<if test="userId != null and userId != ''">and t1.user_id=#{userId}</if>
	<if test="year != null ">and t1.year = #{year}</if>
	<if test="month != null">and t1.month = #{month}</if>
	<if test="platformCode != null and orgId != ''">and t1.platform_code = #{platformCode}</if>
	<if test="areaid != null and areaid != ''">and t1.area_code like CONCAT(#{areaid},'%')</if>
	<if test="orgName !=null and orgName!=''">and t1.org_name like CONCAT('%',#{orgName},'%')</if>
	<if test="provinceCode !=null and provinceCode !=''"> and t1.area_code in(select area_code from TA_AREA where parent_id=#{provinceCode} and level_id='2')</if>
	<if test="cityCode !=null and cityCode!=''">and t1.area_code =#{cityCode}</if>
	group by org_id,org_name 
</select>


<resultMap type="java.util.HashMap" id="OrgResult">
		<result column="org_Id" property="orgId"/>
		<result column="org_name" property="orgName"/>
</resultMap>

<select id="getOrgListByAreaCode" parameterType="string" resultMap="OrgResult">
select org_id,org_name from TA_USER_MONTH_USE_TAKING_COUNT where area_code = #{_parameter} and org_name is not null group by org_id,org_name
</select>

<select id="getUserUseTakingDataGroupByUser" parameterType="map" resultMap="UserMonthUseTakingCountResult">
select t1.user_id,t1.user_name,t1.area_code,t1.org_name,t2.area_name,sum(use_taking) as use_taking,t1.org_id from TA_USER_MONTH_USE_TAKING_COUNT t1 left join TA_AREA t2 on t1.area_code = t2.area_code
    where 1=1
    <if test="year !=null">and t1.year=#{year}</if>
    <if test="month !=null">and t1.month=#{month}</if>
    <if test="areaCode !=null and areaCode !=''">and area_code = #{areaCode}</if>
   	<if test="orgName !=null and orgName!=''">and t1.org_name like CONCAT('%',#{orgName},'%')</if>
   	<if test="orgId !=null and orgId !=''">and t1.org_Id like CONCAT('%',#{orgId},'%')</if>
    <if test="provinceCode !=null and provinceCode !=''"> and t1.area_code in(select area_code from TA_AREA where parent_id=#{provinceCode} and level_id='2')</if>
    group by t1.user_id,t1.user_name,t1.area_code,t1.org_id,t2.area_name,t1.org_name order by use_taking desc
</select>


<select id="getUserUseTakingData" resultMap="UserMonthUseTakingCountResult" parameterType="map">
select count(*) as use_taking from
	    (select count(*) as use_taking from TA_USER_MONTH_USE_TAKING_COUNT where 1=1 
	    <if test="provinceCode !=null and provinceCode !=''"> and area_code in(select area_code from TA_AREA where parent_id=#{provinceCode} and level_id='2')</if>
	    <if test="areaCode !=null and areaCode !=''"> and area_code=#{areaCode}</if>
	    <if test="year !=null"> and year=#{year}</if>
	    <if test="month !=null"> and month=#{month}</if>
	    <if test="orgName !=null and orgName!=''">and org_name like CONCAT('%',#{orgName},'%')</if>
	    group by user_id) as t1
</select>



<select id="getUserMonthUseTakingCountEcharts" parameterType="map" resultMap="UserMonthUseTakingCountResult">
select t1.user_name,t1.org_name,sum(use_taking) as use_taking
            from TA_USER_MONTH_USE_TAKING_COUNT t1 left join TA_AREA t2 on t1.area_code = t2.area_code left join TA_BASE_PROPERTY t3 on t1.platform_code = t3.platform_code and t3.property_key='platform_url'
		where 1=1  
		<if test="orgId != null and orgId != ''">and t1.org_id=#{orgId}</if>
		<if test="userId != null and userId != ''">and t1.user_id=#{userId}</if>
		<if test="year != null ">and t1.year = #{year}</if>
		<if test="month != null">and t1.month = #{month}</if>
		<if test="areaid != null and areaid != ''">and t1.area_code like CONCAT(#{areaid},'%')</if>
		<if test="orgName !=null and orgName!=''">and t1.org_name like CONCAT('%',#{orgName},'%')</if>
		<if test="provinceCode !=null and provinceCode !=''"> and t1.area_code in(select area_code from TA_AREA where parent_id=#{provinceCode} and level_id='2')</if>
		<if test="cityCode !=null and cityCode!=''">and t1.area_code =#{cityCode}</if>
		group by t1.user_id,t1.org_id,t1.org_name,t1.user_name
</select>


</mapper>