<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.whty.assis.demo.dao.CountUseTakingDao">

	<resultMap type="com.whty.assis.demo.model.AreaMonthUseTakingCount"
		id="AreaMonthUseTakingCountResult">
		<result property="createTime" column="create_time" />
		<result property="areaCode" column="area_code" />
		<result property="areaName" column="area_name" />
		<result property="useTaking" column="use_taking" />
		<result property="previousUseTaking" column="previous_use_taking" />
		<result property="rate" column="rate" />
		<result property="updateTime" column="update_time" />
		<result property="year" column="year" />
		<result property="month" column="month" />
		<result property="platformCode" column="platform_code" />
		<result property="platformName" column="platform_name" />
		<result property="useCount" column="use_count" />
		
		
		<result property="orgNum" column="org_num" />
	</resultMap>

	<resultMap type="com.whty.assis.demo.model.OrgMonthUseTakingCount"
		id="OrgMonthUseTakingCountResult">
		<result property="orgId" column="org_id" />
		<result property="orgName" column="org_name" />
		<result property="createTime" column="create_time" />
		<result property="areaCode" column="area_code" />
		<result property="areaName" column="area_name" />
		<result property="rate" column="rate" />
		<result property="previousUseTaking" column="previous_use_taking" />
		<result property="useTaking" column="use_taking" />
		<result property="updateTime" column="update_time" />
		<result property="year" column="year" />
		<result property="month" column="month" />
		<result property="platformCode" column="platform_code" />
		<result property="platformName" column="platform_name" />
		<result property="useCount" column="use_count" />
		<result property="orgNum" column="org_num" />
		<result property="userNum" column="user_num" />
	</resultMap>


	<resultMap type="com.whty.assis.demo.model.UserMonthUseTakingCount"
		id="UserMonthUseTakingCountResult">
		<result property="orgId" column="org_id" />
		<result property="orgName" column="org_name" />
		<result property="createTime" column="create_time" />
		<result property="areaCode" column="area_code" />
		<result property="areaName" column="area_name" />
		<result property="rate" column="rate" />
		<result property="previousUseTaking" column="previous_use_taking" />
		<result property="useTaking" column="use_taking" />
		<result property="updateTime" column="update_time" />
		<result property="year" column="year" />
		<result property="month" column="month" />
		<result property="platformCode" column="platform_code" />
		<result property="platformName" column="platform_name" />
		<result property="userId" column="user_id" />
		<result property="userName" column="user_name" />
		<result property="useCount" column="use_count" />
	</resultMap>

	<select id="getCountData" resultMap="AreaMonthUseTakingCountResult">
		select count(1) as use_taking from 
		(select area_code from T_WIDGET_HISTORY 
		group by area_code) t1
		union
		select count(1) as use_taking from 
		(select org_id from T_WIDGET_HISTORY 
		group by org_id) t2
		union
		select count(1) as use_taking from 
		(select user_id from T_WIDGET_HISTORY 
		group by user_id) t3
	</select>

	<select id="getAreaCountData" resultMap="AreaMonthUseTakingCountResult" parameterType="map">
		select count(distinct area_code) as use_taking from T_USE_TAKING_AREA_COUNT
		where 1=1
		<if test="provinceCode !=null and provinceCode !=''"> and area_code in(select area_code from TA_AREA where
			parent_id=#{provinceCode} and level_id='2')</if>
		<if test="year !=null"> and year=#{year}</if>
		<if test="month !=null"> and month=#{month}</if>
		union all
		select sum(use_taking) as use_taking from T_USE_TAKING_AREA_COUNT
		where 1=1
		<if test="provinceCode !=null and provinceCode !=''"> and area_code in(select area_code from TA_AREA where
			parent_id=#{provinceCode} and level_id='2')</if>
		<if test="year !=null"> and year=#{year}</if>
		<if test="month !=null"> and month=#{month}</if>
		union all
		select count(distinct org_id) as use_taking from T_USE_TAKING_ORG_COUNT
		where 1=1
		<if test="provinceCode !=null and provinceCode !=''"> and area_code in(select area_code from TA_AREA where
			parent_id=#{provinceCode} and level_id='2')</if>
		<if test="year !=null"> and year=#{year}</if>
		<if test="month !=null"> and month=#{month}</if>
	</select>
	
	<select id="getAreaUseTakingDataGroupByArea" parameterType="map"
		resultMap="AreaMonthUseTakingCountResult">
		select area_code,area_name,year,month,sum(use_taking) as use_taking,count(distinct org_id) as org_num from T_USE_TAKING_ORG_COUNT
		where 1=1
		<if test="year !=null">and year=#{year}</if>
		<if test="month !=null">and month=#{month}</if>
		<if test="cityCode !=null and cityCode !=''">and area_code = #{cityCode}</if>
		<if test="provinceCode !=null and provinceCode !=''"> and area_code in(select area_code from TA_AREA where
			parent_id=#{provinceCode} and level_id='2')</if>
		group by area_code,area_name order by use_taking desc
	</select>

	<select id="getAreaMonthUseTakingCountData" parameterType="map" resultMap="AreaMonthUseTakingCountResult">
		select t1.area_code,t1.area_name,sum(t1.use_taking) as use_taking,t1.year,t1.month from T_USE_TAKING_AREA_COUNT t1 
		left join TA_BASE_PROPERTY t3 on t1.platform_code = t3.platform_code and t3.property_key='platform_url'
          where 1=1
			<if test="year != null ">and t1.year = #{year}</if>
			<if test="month != null">and t1.month = #{month}</if>
			<if test="platformCode != null">and t1.platform_code = #{platformCode}</if>
			<if test="areaid != null and areaid != ''">and t1.area_code like CONCAT(#{areaid},'%')</if>
			<if test="orgName !=null and orgName!=''">and t1.org_name like CONCAT('%',#{orgName},'%')</if>
			<if test="orgId !=null and orgId !=''">and t1.org_id = #{orgId} </if>
			<if test="cityCode !=null and cityCode!=''">and t1.area_code =#{cityCode}</if>
			<if test="provinceCode !=null and provinceCode !=''"> and t1.area_code in(select area_code from TA_AREA where parent_id=#{provinceCode} and level_id='2')</if>
		group by t1.area_code order by use_taking desc
	</select>

	<select id="getOrgUseTakingData" parameterType="map" resultMap="OrgMonthUseTakingCountResult">
		select count(distinct org_id) as use_taking from T_USE_TAKING_ORG_COUNT
		    where 1=1 
		    <if test="provinceCode !=null and provinceCode !=''"> and area_code in(select area_code from TA_AREA where parent_id=#{provinceCode} and level_id='2')</if>
		    <if test="cityCode !=null and cityCode !=''"> and area_code=#{cityCode}</if>
		    <if test="year !=null"> and year=#{year}</if>
		    <if test="month !=null"> and month=#{month}</if>
		    <if test="orgName !=null and orgName!=''">and org_name like CONCAT('%',#{orgName},'%')</if>
		union all 
			select sum(use_taking) as use_taking from T_USE_TAKING_ORG_COUNT
	    	where 1=1 
	   		<if test="provinceCode !=null and provinceCode !=''"> and area_code in(select area_code from TA_AREA where parent_id=#{provinceCode} and level_id='2')</if>
		    <if test="cityCode !=null and cityCode !=''"> and area_code=#{cityCode}</if>
		    <if test="year !=null"> and year=#{year}</if>
		    <if test="month !=null"> and month=#{month}</if>
		    <if test="orgName !=null and orgName!=''">and org_name like CONCAT('%',#{orgName},'%')</if>
		union all
			select count(distinct user_id) as use_taking from T_USE_TAKING_USER_COUNT
			where 1=1
			<if test="provinceCode !=null and provinceCode !=''"> and area_code in(select area_code from TA_AREA where
				parent_id=#{provinceCode} and level_id='2')</if>
			<if test="cityCode !=null and cityCode !=''"> and area_code=#{cityCode}</if>
			<if test="year !=null"> and year=#{year}</if>
			<if test="month !=null"> and month=#{month}</if>
			<if test="orgName !=null and orgName!=''">and org_name like CONCAT('%',#{orgName},'%')</if>
	</select>

	<select id="getOrgUseTakingDataGroupByOrg" parameterType="map" resultMap="OrgMonthUseTakingCountResult">
	select area_name,area_code, org_id,org_name,sum(use_taking) as use_taking,count(distinct user_id) as user_num from T_USE_TAKING_USER_COUNT
	where 1=1 
	<if test="year !=null">and year=#{year}</if>
	<if test="month !=null">and month=#{month}</if>
	<if test="cityCode !=null and cityCode !=''">and area_code = #{cityCode}</if>
	<if test="orgId !=null and orgId !=''">and org_id = #{orgId}</if>
	<if test="orgName !=null and orgName!=''">and org_name like CONCAT('%',#{orgName},'%')</if>
	<if test="provinceCode !=null and provinceCode !=''"> and area_code in(select area_code from TA_AREA where parent_id=#{provinceCode} and level_id='2')</if>
	group by org_id,org_name,area_code,area_name order by use_taking desc
</select>

<select id="getOrgListByAreaCode" parameterType="map" resultMap="UserMonthUseTakingCountResult">
select org_id,org_name from T_USE_TAKING_USER_COUNT 
where area_code = #{areaCode} and org_name is not null 
<if test="year !=null">and year=#{year}</if>
<if test="month !=null">and month=#{month}</if>
group by org_id,org_name
</select>

<select id="getUserUseTakingData" resultMap="UserMonthUseTakingCountResult" parameterType="map">
	select count(distinct user_id) as use_taking from T_USE_TAKING_USER_COUNT
	    where 1=1 
	    <if test="provinceCode !=null and provinceCode !=''"> and area_code in(select area_code from TA_AREA where parent_id=#{provinceCode} and level_id='2')</if>
	    <if test="cityCode !=null and cityCode !=''"> and area_code=#{cityCode}</if>
	    <if test="year !=null"> and year=#{year}</if>
	    <if test="month !=null"> and month=#{month}</if>
	    <if test="orgName !=null and orgName!=''">and org_name like CONCAT('%',#{orgName},'%')</if>
	    <if test="orgId !=null and orgId !=''">and org_id = #{orgId}</if>
	union all 
			select sum(use_taking) as use_taking from T_USE_TAKING_USER_COUNT
	    	where 1=1 
	   		<if test="provinceCode !=null and provinceCode !=''"> and area_code in(select area_code from TA_AREA where parent_id=#{provinceCode} and level_id='2')</if>
		    <if test="cityCode !=null and cityCode !=''"> and area_code=#{cityCode}</if>
		    <if test="year !=null"> and year=#{year}</if>
		    <if test="month !=null"> and month=#{month}</if>
		    <if test="orgName !=null and orgName!=''">and org_name like CONCAT('%',#{orgName},'%')</if>
		    <if test="orgId !=null and orgId !=''">and org_id = #{orgId}</if>
</select>

<select id="getUserUseTakingDataGroupByUser" parameterType="map" resultMap="UserMonthUseTakingCountResult">
select user_id,user_name,area_code,org_id,org_name,area_name,sum(use_taking) as use_taking from T_USE_TAKING_USER_COUNT 
    where 1=1
    <if test="year !=null">and year=#{year}</if>
    <if test="month !=null">and month=#{month}</if>
    <if test="cityCode !=null and cityCode !=''">and area_code = #{cityCode}</if>
   	<if test="orgName !=null and orgName!=''">and org_name like CONCAT('%',#{orgName},'%')</if>
   	<if test="orgId !=null and orgId !=''">and org_Id like CONCAT('%',#{orgId},'%')</if>
    <if test="provinceCode !=null and provinceCode !=''"> and area_code in(select area_code from TA_AREA where parent_id=#{provinceCode} and level_id='2')</if>
    group by user_id,user_name,area_code,org_id,area_name,org_name order by use_taking desc
</select>

<select id="getOrgMonthUseTakingCountEcharts" parameterType="map" resultMap="OrgMonthUseTakingCountResult">
	select t1.org_id,t1.org_name,sum(t1.use_taking) as use_taking from T_USE_TAKING_ORG_COUNT t1 
	left join TA_BASE_PROPERTY t3 on t1.platform_code = t3.platform_code and t3.property_key='platform_url'
    where 1=1
	<if test="orgId != null and orgId != ''">and t1.org_id=#{orgId}</if>
	<if test="userId != null and userId != ''">and t1.user_id=#{userId}</if>
	<if test="year != null ">and t1.year = #{year}</if>
	<if test="month != null">and t1.month = #{month}</if>
	<if test="platformCode != null and orgId != ''">and t1.platform_code = #{platformCode}</if>
	<if test="areaid != null and areaid != ''">and t1.area_code like CONCAT(#{areaid},'%')</if>
	<if test="orgName !=null and orgName!=''">and t1.org_name like CONCAT('%',#{orgName},'%')</if>
	<if test="provinceCode !=null and provinceCode !=''"> and t1.area_code in(select area_code from TA_AREA where parent_id=#{provinceCode} and level_id='2')</if>
	<if test="cityCode !=null and cityCode!=''">and t1.area_code =#{cityCode}</if>
	group by t1.org_id
</select>

<select id="getUserMonthUseTakingCountEcharts" parameterType="map" resultMap="UserMonthUseTakingCountResult">
	select t1.user_name,t1.org_name,sum(t1.use_taking) as use_taking from T_USE_TAKING_USER_COUNT t1 
	left join TA_BASE_PROPERTY t3 on t1.platform_code = t3.platform_code and t3.property_key='platform_url'
		where 1=1  
		<if test="orgId != null and orgId != ''">and t1.org_id=#{orgId}</if>
		<if test="userId != null and userId != ''">and t1.user_id=#{userId}</if>
		<if test="year != null ">and t1.year = #{year}</if>
		<if test="month != null">and t1.month = #{month}</if>
		<if test="areaid != null and areaid != ''">and t1.area_code like CONCAT(#{areaid},'%')</if>
		<if test="orgName !=null and orgName!=''">and t1.org_name like CONCAT('%',#{orgName},'%')</if>
		<if test="provinceCode !=null and provinceCode !=''"> and t1.area_code in(select area_code from TA_AREA where parent_id=#{provinceCode} and level_id='2')</if>
		<if test="cityCode !=null and cityCode!=''">and t1.area_code =#{cityCode}</if>
	group by t1.user_name
</select>




<resultMap type="java.util.HashMap" id="OrgResult">
		<result column="org_Id" property="orgId"/>
		<result column="org_name" property="orgName"/>
</resultMap>


</mapper>