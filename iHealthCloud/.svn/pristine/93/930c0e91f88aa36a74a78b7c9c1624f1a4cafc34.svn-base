package com.yhcrt.iHealthCloud.service.impl;

import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;

import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.JSONArray;
import com.alibaba.fastjson.JSONObject;
import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import com.yhcrt.iHealthCloud.base.BaseService;
import com.yhcrt.iHealthCloud.common.Constants;
import com.yhcrt.iHealthCloud.entity.Employee;
import com.yhcrt.iHealthCloud.entity.EmployeeExample;
import com.yhcrt.iHealthCloud.entity.Member;
import com.yhcrt.iHealthCloud.entity.MemberAddress;
import com.yhcrt.iHealthCloud.entity.MemberAddressExample;
import com.yhcrt.iHealthCloud.entity.OrderRefund;
import com.yhcrt.iHealthCloud.entity.Organization;
import com.yhcrt.iHealthCloud.entity.ServiceLog;
import com.yhcrt.iHealthCloud.entity.WorkOrder;
import com.yhcrt.iHealthCloud.entity.WorkOrderExample;
import com.yhcrt.iHealthCloud.entity.YwImage;
import com.yhcrt.iHealthCloud.entity.YwImageExample;
import com.yhcrt.iHealthCloud.mapper.EmployeeMapper;
import com.yhcrt.iHealthCloud.mapper.MemberAddressMapper;
import com.yhcrt.iHealthCloud.mapper.MemberMapper;
import com.yhcrt.iHealthCloud.mapper.OrderRefundMapper;
import com.yhcrt.iHealthCloud.mapper.OrganizationMapper;
import com.yhcrt.iHealthCloud.mapper.ServiceLogMapper;
import com.yhcrt.iHealthCloud.mapper.ServiceMapper;
import com.yhcrt.iHealthCloud.mapper.WorkOrderMapper;
import com.yhcrt.iHealthCloud.mapper.YwImageMapper;
import com.yhcrt.iHealthCloud.pojo.OrderServiceLog;
import com.yhcrt.iHealthCloud.pojo.OrgServicer;
import com.yhcrt.iHealthCloud.pojo.WorkOrderTrace;
import com.yhcrt.iHealthCloud.service.SysSequenceService;
import com.yhcrt.iHealthCloud.service.WorkOrderService;
import com.yhcrt.iHealthCloud.util.Const;
import com.yhcrt.iHealthCloud.util.DateUtil;
import com.yhcrt.iHealthCloud.util.DateUtils;
import com.yhcrt.iHealthCloud.util.RequestUtils;
import com.yhcrt.iHealthCloud.util.WxAppletUserInfo;

/* @Description: 	
 * @version 1.0     2017年9月7日	
 * @author jimmy	
 */
@Service
public class WorkOrderServiceImpl extends BaseService implements WorkOrderService {

	@Autowired
	private WorkOrderMapper workOrderMapper;
	@Autowired
	private ServiceMapper serviceMapper;
	@Autowired
	private MemberMapper memberMapper;
	@Autowired
	private MemberAddressMapper memberAddressMapper;
	@Autowired
	private OrderRefundMapper orderRefundMapper;
	@Autowired
	private OrganizationMapper organizationMapper;
	@Autowired
	private EmployeeMapper employeeMapper;

	@Autowired
	private SysSequenceService sequenceService;
	
	@Autowired
	private ServiceLogMapper serviceLogMapper;
	@Autowired
	private YwImageMapper ywImageMapper;

	/*
	 * (non-Javadoc)
	 * 
	 * @see
	 * com.yhcrt.healthcloud.mall.service.WorkOrderService#add(com.yhcrt.healthcloud
	 * .mall.entity.WorkOrder)
	 */
	@Override
	public Integer add(WorkOrder workOrder) {
		return workOrderMapper.insert(workOrder);
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see
	 * com.yhcrt.healthcloud.mall.service.WorkOrderService#del(java.lang.String)
	 */
	@Override
	public Integer del(Integer cid) {
		return workOrderMapper.deleteByPrimaryKey(cid);
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see
	 * com.yhcrt.healthcloud.mall.service.WorkOrderService#upd(com.yhcrt.healthcloud
	 * .mall.entity.WorkOrder)
	 */
	@Override
	public Integer upd(WorkOrder workOrder) {
		return workOrderMapper.updateByPrimaryKey(workOrder);
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see
	 * com.yhcrt.healthcloud.mall.service.WorkOrderService#get(java.lang.String)
	 */
	@Override
	public WorkOrder get(Integer cid) {
		return workOrderMapper.selectByPrimaryKey(cid);
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see com.yhcrt.healthcloud.mall.service.WorkOrderService#getAll()
	 */
	@Override
	public List<WorkOrder> getAll(HashMap<String, Object> params) {
		return workOrderMapper.search(params);
	}

	@Override
	public WorkOrder getByOrderNo(String orderNo) {
		WorkOrderExample example = new WorkOrderExample();
		example.createCriteria().andCext2EqualTo(orderNo);
		List<WorkOrder> workOrderList = workOrderMapper
				.selectByExample(example);
		if (workOrderList.size() > 0) {
			return workOrderList.get(0);
		}
		return null;
	}

	@Override
	public String getWorkOrderList(JSONObject pdataObj) {
		// 获取参数
		JSONObject biz = pdataObj.getJSONObject("biz");
		String memberid = biz.getString("member_id");
		String orderstatus = biz.getString("order_status");
		String currentPage = biz.getString(Const.TAG_CURRENT_PAGE);
		String pageSize = biz.getString(Const.TAG_PAGE_SIZE);
		// 对参数进行非空判断
		if (judgeAgumentsIsLegal(pdataObj, memberid, currentPage, pageSize)) {
			// 向数据库请求数据并判断是否分页
			List<WorkOrder> list;
			if (judgePageInfoIsLegal(currentPage, pageSize)) {
				PageHelper.startPage(Integer.parseInt(currentPage),
						Integer.parseInt(pageSize));
				list = selectWorkOrderList(memberid, orderstatus);
				PageInfo<WorkOrder> pageInfo = new PageInfo<>(list);
				setPagingData(pdataObj, pageInfo.getPages(),
						pageInfo.getPageNum());
			} else {
				list = selectWorkOrderList(memberid, orderstatus);
			}
			JSONArray workOrders = new JSONArray();
			for (WorkOrder workOrder : list) {
				MemberAddressExample example = new MemberAddressExample();
				example.createCriteria()
						.andMemberIdEqualTo(Integer.valueOf(memberid))
						.andPhoneNumEqualTo(workOrder.getTel());
				List<MemberAddress> memberAddressList = memberAddressMapper
						.selectByExample(example);
				MemberAddress memberAddress = new MemberAddress();
				if (memberAddressList.size() > 0) {
					for (MemberAddress add : memberAddressList) {
						if (add.getIsDefault() != null
								&& add.getIsDefault() == 1) {
							memberAddress = add;
							break;
						}
					}
					if (memberAddress.getCid() == null) {
						memberAddress = memberAddressList.get(0);
					}
				}
				JSONObject workOrderJson = (JSONObject) JSON.toJSON(workOrder);
				com.yhcrt.iHealthCloud.entity.Service service = serviceMapper
						.selectByPrimaryKey(workOrder.getServiceId());
				workOrderJson.put("serviceName", service.getServiceName());
				workOrderJson.put("serviceLogo", service.getTitleImg());
				workOrderJson.put("serviceUnit", service.getCext1());
				workOrderJson.put("addressId", memberAddress.getCid());
				workOrderJson.put("serviceOrg", service.getOrg().getOrgName());
				workOrderJson.put("orgId", service.getOrg().getOrgId());
				workOrders.add(workOrderJson);
			}
			pdataObj.put(Const.TAG_BIZ, workOrders);
			pdataObj.put(Const.TAG_STS, Const.TAG_STS_SUCCESS);
			pdataObj.put(Const.TAG_RMK, "获取成功！");
		} else {
			requestFailed(pdataObj, Const.RMK_BIZ_PARAM_NULL);
		}
		return pdataObj.toJSONString();
	}

	@Override
	public String getWorkOrderDetail(JSONObject pdataObj) {
		// 获取参数
		JSONObject biz = pdataObj.getJSONObject("biz");
		String ordernum = biz.getString("order_num");
		WorkOrderExample example = new WorkOrderExample();
		example.createCriteria().andCext1EqualTo(ordernum);
		List<WorkOrder> empList = workOrderMapper.selectByExample(example);
		if (empList.size() > 0) {
			WorkOrder workOrder = empList.get(0);
			JSONObject workOrderJson = (JSONObject) JSON.toJSON(workOrder);
			com.yhcrt.iHealthCloud.entity.Service service = serviceMapper
					.selectByPrimaryKey(workOrder.getServiceId());
			workOrderJson.put("serviceName", service.getServiceName());
			workOrderJson.put("serviceLogo", service.getTitleImg());
			workOrderJson.put("orgId", service.getOrg().getOrgId());
			workOrderJson.put("orgName", service.getOrg().getOrgName());
			workOrderJson.put("serviceUnit", service.getCext1());
			pdataObj.put(Const.TAG_BIZ, workOrderJson);
			pdataObj.put(Const.TAG_STS, Const.TAG_STS_SUCCESS);
			pdataObj.put(Const.TAG_RMK, "获取成功！");
		} else {
			pdataObj.put(Const.TAG_STS, Const.TAG_STS_FAIL);
			pdataObj.put(Const.TAG_RMK, "获取失败,未查询到此订单号！");
		}
		return pdataObj.toJSONString();
	}

	@Override
	public String undistributed(JSONObject pdataObj) {
		/** 获取待分配工单列表 */
		try {
			// 获取参数
			JSONObject biz = pdataObj.getJSONObject("biz");
			String orgid = biz.getString("org_id");
			if (StringUtils.isEmpty(orgid)) {
				pdataObj.put(Const.TAG_STS, Const.TAG_STS_FAIL);
				pdataObj.put(Const.TAG_RMK, "机构id不能为空！");
				return pdataObj.toJSONString();
			}
			Organization org = organizationMapper.selectByPrimaryKey(Integer.valueOf(orgid));
			if (org == null) {
				pdataObj.put(Const.TAG_STS, Const.TAG_STS_FAIL);
				pdataObj.put(Const.TAG_RMK, "未查询到此机构！");
				return pdataObj.toJSONString();
			}
			String currentPage = biz.getString(Const.TAG_CURRENT_PAGE);
			String pageSize = biz.getString(Const.TAG_PAGE_SIZE);
			// 对参数进行非空判断
			if (judgeAgumentsIsLegal(pdataObj, orgid, currentPage, pageSize)) {
				// 向数据库请求数据并判断是否分页
				List<WorkOrder> workOrderList;
				if (judgePageInfoIsLegal(currentPage, pageSize)) {
					PageHelper.startPage(Integer.parseInt(currentPage), Integer.parseInt(pageSize));
					workOrderList = workOrderMapper.selectUndistributed(org.getOrgCode());
					PageInfo<WorkOrder> pageInfo = new PageInfo<>(workOrderList);
					setPagingData(pdataObj, pageInfo.getPages(), pageInfo.getPageNum());
				} else {
					workOrderList = workOrderMapper.selectUndistributed(org.getOrgCode());
				}
				JSONArray workOrderJsonArray = new JSONArray();
				for (WorkOrder workOrder : workOrderList) {
					JSONObject userCommentJson = new JSONObject();
					userCommentJson.put("order_id", workOrder.getOrderId());
					userCommentJson.put("cext1", workOrder.getCext1());	//工单编号
					if(workOrder.getService() != null){
						userCommentJson.put("serviceIntro", workOrder.getService().getServiceIntro());	//工单编号
					}else{
						userCommentJson.put("serviceIntro", "暂无简介");
					}
					userCommentJson.put("order_status", workOrder.getOrderStatus());
					userCommentJson.put("order_content", workOrder.getOrderContent());
					if (workOrder.getMember() != null) {
						userCommentJson.put("pay_user", workOrder.getMember().getNickName());
					}
					if (workOrder.getService() != null) {
						userCommentJson.put("service_img", workOrder.getService().getTitleImg());
					}
					workOrderJsonArray.add(userCommentJson);
				}
				pdataObj.put(Const.TAG_BIZ, workOrderJsonArray);
				pdataObj.put(Const.TAG_STS, Const.TAG_STS_SUCCESS);
				pdataObj.put(Const.TAG_RMK, "获取成功！");
			} else {
				requestFailed(pdataObj, Const.RMK_BIZ_PARAM_NULL);
			}
			return pdataObj.toJSONString();
		} catch (Exception e) {
			pdataObj.put(Const.TAG_STS, Const.TAG_STS_FAIL);
			pdataObj.put(Const.TAG_RMK, "服务器内部错误");
			return pdataObj.toJSONString();
		}
	}

	@Override
	public String workOrdersAll(JSONObject pdataObj) {
		/** 获取全部工单列表 */
		try {
			// 获取参数
			JSONObject biz = pdataObj.getJSONObject("biz");
			String orgid = biz.getString("org_id");
			String status = biz.getString("status");
			if (StringUtils.isEmpty(orgid)) {
				pdataObj.put(Const.TAG_STS, Const.TAG_STS_FAIL);
				pdataObj.put(Const.TAG_RMK, "机构id不能为空！");
				return pdataObj.toJSONString();
			}
			Organization org = organizationMapper.selectByPrimaryKey(Integer.valueOf(orgid));
			if (org == null) {
				pdataObj.put(Const.TAG_STS, Const.TAG_STS_FAIL);
				pdataObj.put(Const.TAG_RMK, "未查询到此机构！");
				return pdataObj.toJSONString();
			}
			String currentPage = biz.getString(Const.TAG_CURRENT_PAGE);
			String pageSize = biz.getString(Const.TAG_PAGE_SIZE);
			// 对参数进行非空判断
			if (judgeAgumentsIsLegal(pdataObj, orgid, currentPage, pageSize)) {
				// 向数据库请求数据并判断是否分页
				List<WorkOrder> workOrderList;
				if (judgePageInfoIsLegal(currentPage, pageSize)) {
					PageHelper.startPage(Integer.parseInt(currentPage), Integer.parseInt(pageSize));
					workOrderList = workOrderMapper.workOrdersAll(org.getOrgCode(), status);
					PageInfo<WorkOrder> pageInfo = new PageInfo<>(workOrderList);
					setPagingData(pdataObj, pageInfo.getPages(),pageInfo.getPageNum());
				} else {
					workOrderList = workOrderMapper.workOrdersAll(org.getOrgCode(), status);
				}
				JSONArray workOrderJsonArray = new JSONArray();
				for (WorkOrder workOrder : workOrderList) {
					JSONObject userCommentJson = new JSONObject();
					userCommentJson.put("order_id", workOrder.getOrderId());
					userCommentJson.put("order_status", workOrder.getOrderStatus());
					userCommentJson.put("order_content", workOrder.getOrderContent());
					if (workOrder.getMember() != null) {
						userCommentJson.put("pay_user", workOrder.getMember().getNickName());
					}
					if (workOrder.getService() != null) {
						userCommentJson.put("service_img", workOrder.getService().getTitleImg());
					}
					workOrderJsonArray.add(userCommentJson);
				}
				pdataObj.put(Const.TAG_BIZ, workOrderJsonArray);
				pdataObj.put(Const.TAG_STS, Const.TAG_STS_SUCCESS);
				pdataObj.put(Const.TAG_RMK, "获取成功！");
			} else {
				requestFailed(pdataObj, Const.RMK_BIZ_PARAM_NULL);
			}
			return pdataObj.toJSONString();
		} catch (Exception e) {
			pdataObj.put(Const.TAG_STS, Const.TAG_STS_FAIL);
			pdataObj.put(Const.TAG_RMK, "服务器内部错误");
			return pdataObj.toJSONString();
		}
	}

	@Override
	public String sendToMe(JSONObject pdataObj) {
		/** 分配给我的工单 */
		try {
			// 获取参数
			JSONObject biz = pdataObj.getJSONObject("biz");
			String emp_id = biz.getString("emp_id");
			String status = biz.getString("status");
			if (StringUtils.isEmpty(emp_id)) {
				pdataObj.put(Const.TAG_STS, Const.TAG_STS_FAIL);
				pdataObj.put(Const.TAG_RMK, "服务人员id不能为空！");
				return pdataObj.toJSONString();
			}
			Employee emp = employeeMapper.selectByPrimaryKey(Integer.valueOf(emp_id));
			if (emp == null) {
				pdataObj.put(Const.TAG_STS, Const.TAG_STS_FAIL);
				pdataObj.put(Const.TAG_RMK, "未查询到此服务人员！");
				return pdataObj.toJSONString();
			}
			String currentPage = biz.getString(Const.TAG_CURRENT_PAGE);
			String pageSize = biz.getString(Const.TAG_PAGE_SIZE);
			// 对参数进行非空判断
			if (judgeAgumentsIsLegal(pdataObj, emp_id, currentPage, pageSize)) {
				// 向数据库请求数据并判断是否分页
				List<WorkOrder> workOrderList;
				if (judgePageInfoIsLegal(currentPage, pageSize)) {
					PageHelper.startPage(Integer.parseInt(currentPage), Integer.parseInt(pageSize));
					workOrderList = workOrderMapper.sendToMe(emp_id, status);
					PageInfo<WorkOrder> pageInfo = new PageInfo<>(workOrderList);
					setPagingData(pdataObj, pageInfo.getPages(), pageInfo.getPageNum());
				} else {
					workOrderList = workOrderMapper.sendToMe(emp_id, status);
				}
				JSONArray workOrderJsonArray = new JSONArray();
				for (WorkOrder workOrder : workOrderList) {
					JSONObject userCommentJson = new JSONObject();
					userCommentJson.put("order_id", workOrder.getOrderId());
					userCommentJson.put("order_status", workOrder.getOrderStatus());
					userCommentJson.put("order_content", workOrder.getOrderContent());
					if (workOrder.getMember() != null) {
						userCommentJson.put("pay_user", workOrder.getMember().getNickName());
					}
					if (workOrder.getService() != null) {
						userCommentJson.put("service_img", workOrder.getService().getTitleImg());
					}
					workOrderJsonArray.add(userCommentJson);
				}
				pdataObj.put(Const.TAG_BIZ, workOrderJsonArray);
				pdataObj.put(Const.TAG_STS, Const.TAG_STS_SUCCESS);
				pdataObj.put(Const.TAG_RMK, "获取成功！");
			} else {
				requestFailed(pdataObj, Const.RMK_BIZ_PARAM_NULL);
			}
			return pdataObj.toJSONString();
		} catch (Exception e) {
			pdataObj.put(Const.TAG_STS, Const.TAG_STS_FAIL);
			pdataObj.put(Const.TAG_RMK, "服务器内部错误");
			return pdataObj.toJSONString();
		}
	}

	@Override
	public String orderDetail(JSONObject pdataObj) {
		/** 获取工单详情 */
		try {
			// 获取参数
			JSONObject biz = pdataObj.getJSONObject("biz");
			String order_id = biz.getString("order_id");
			if (StringUtils.isEmpty(order_id)) {
				pdataObj.put(Const.TAG_STS, Const.TAG_STS_FAIL);
				pdataObj.put(Const.TAG_RMK, "工单id不能为空！");
				return pdataObj.toJSONString();
			}
			WorkOrder workOrder = workOrderMapper.orderDetail(Integer.valueOf(order_id));
			JSONObject workOrderJson = (JSONObject) JSONObject.toJSON(workOrder);
			pdataObj.put(Const.TAG_BIZ, workOrderJson);
			pdataObj.put(Const.TAG_STS, Const.TAG_STS_SUCCESS);
			pdataObj.put(Const.TAG_RMK, "");
			return pdataObj.toJSONString();
		} catch (Exception e) {
			pdataObj.put(Const.TAG_STS, Const.TAG_STS_FAIL);
			pdataObj.put(Const.TAG_RMK, "服务器内部错误");
			return pdataObj.toJSONString();
		}
	}

	@Override
	public String distribute(JSONObject pdataObj) {
		/** 分配服务人员 */
		try {
			// 获取参数
			JSONObject biz = pdataObj.getJSONObject("biz");
			String order_id = biz.getString("order_id");
			String emp_id = biz.getString("emp_id");
			String handler_id = biz.getString("handler_id");
			if (StringUtils.isEmpty(handler_id)) {
				pdataObj.put(Const.TAG_STS, Const.TAG_STS_FAIL);
				pdataObj.put(Const.TAG_RMK, "管理员id不能为空！");
				return pdataObj.toJSONString();
			}
			if (StringUtils.isEmpty(order_id)) {
				pdataObj.put(Const.TAG_STS, Const.TAG_STS_FAIL);
				pdataObj.put(Const.TAG_RMK, "工单id不能为空！");
				return pdataObj.toJSONString();
			}
			if (StringUtils.isEmpty(emp_id)) {
				pdataObj.put(Const.TAG_STS, Const.TAG_STS_FAIL);
				pdataObj.put(Const.TAG_RMK, "服务人员不能为空！");
				return pdataObj.toJSONString();
			}
			Employee emp = employeeMapper.selectByPrimaryKey(Integer.valueOf(emp_id));
			if (emp == null) {
				pdataObj.put(Const.TAG_STS, Const.TAG_STS_FAIL);
				pdataObj.put(Const.TAG_RMK, "未查询到此服务人员！");
				return pdataObj.toJSONString();
			}
			Employee handler = employeeMapper.selectByPrimaryKey(Integer.valueOf(handler_id));
			if (handler == null) {
				pdataObj.put(Const.TAG_STS, Const.TAG_STS_FAIL);
				pdataObj.put(Const.TAG_RMK, "未查询到此管理人员！");
				return pdataObj.toJSONString();
			}
			WorkOrder workOrder = workOrderMapper.orderDetail(Integer.valueOf(order_id));
			if (workOrder == null) {
				pdataObj.put(Const.TAG_STS, Const.TAG_STS_FAIL);
				pdataObj.put(Const.TAG_RMK, "未查询到此工单！");
				return pdataObj.toJSONString();
			}
			if (workOrder.getToUser() != null) {
				pdataObj.put(Const.TAG_STS, Const.TAG_STS_FAIL);
				pdataObj.put(Const.TAG_RMK, "此工单已经分配过服务人员！");
				return pdataObj.toJSONString();
			}
			workOrder.setHandler(handler_id);
			workOrder.setCext3(DateUtils.dateToString19(new Date()));
			workOrder.setToUser(emp_id);
			workOrderMapper.updateByPrimaryKeySelective(workOrder);
			pdataObj.put(Const.TAG_STS, Const.TAG_STS_SUCCESS);
			pdataObj.put(Const.TAG_RMK, "分配成功");
			return pdataObj.toJSONString();
		} catch (Exception e) {
			pdataObj.put(Const.TAG_STS, Const.TAG_STS_FAIL);
			pdataObj.put(Const.TAG_RMK, "服务器内部错误");
			return pdataObj.toJSONString();
		}
	}

	@Override
	public String setWorkOrderStatus(JSONObject pdataObj) {
		// 获取参数
		JSONObject biz = pdataObj.getJSONObject("biz");
		String ordernum = biz.getString("order_num");
		String orderstatus = biz.getString("order_status");
		if (StringUtils.isEmpty(orderstatus)) {
			pdataObj.put(Const.TAG_STS, Const.TAG_STS_FAIL);
			pdataObj.put(Const.TAG_RMK, "订单状态参数不能为空！");
			return pdataObj.toJSONString();
		}
		WorkOrderExample example = new WorkOrderExample();
		example.createCriteria().andCext1EqualTo(ordernum);
		List<WorkOrder> empList = workOrderMapper.selectByExample(example);
		if (empList.size() > 0) {
			WorkOrder workOrder = empList.get(0);
			workOrder.setOrderStatus(Integer.valueOf(orderstatus));
			workOrderMapper.updateByPrimaryKeySelective(workOrder);
			pdataObj.put(Const.TAG_STS, Const.TAG_STS_SUCCESS);
			pdataObj.put(Const.TAG_RMK, "数据修改成功！");
		} else {
			pdataObj.put(Const.TAG_STS, Const.TAG_STS_FAIL);
			pdataObj.put(Const.TAG_RMK, "获取失败,未查询到此订单号！");
		}
		return pdataObj.toJSONString();
	}

	private List<WorkOrder> selectWorkOrderList(String memberId, String orderstatus) { // 页面中传值 1待支付 2进行中 3完成 4已关闭
		WorkOrderExample example = new WorkOrderExample();
		example.setOrderByClause("create_time desc");
		if (!StringUtils.isEmpty(orderstatus)) { // 1 2 3 4
			Integer status = null;
			if ("1".equals(orderstatus)) {
				status = Constants.OrderType.ORDER_NOPAY;
			}
			if ("2".equals(orderstatus)) {
				status = Constants.OrderType.ORDER_DOING;
			}
			if ("3".equals(orderstatus)) {
				status = Constants.OrderType.ORDER_TODONE;
			}
			if ("4".equals(orderstatus)) {
				status = Constants.OrderType.ORDER_DONE;
			}
			example.createCriteria().andMemberIdEqualTo(Integer.valueOf(memberId))
					.andOrderStatusEqualTo(status);
		} else {
			example.createCriteria().andMemberIdEqualTo(Integer.valueOf(memberId));
		}
		List<WorkOrder> empList = workOrderMapper.selectByExample(example);
		return empList;
	}

	public List<WorkOrder> selectYwOrderList(Integer orderstatus) {
		WorkOrderExample example = new WorkOrderExample();
		example.setOrderByClause("create_time desc");
		if (orderstatus != null) {
			example.createCriteria().andOrderStatusEqualTo(orderstatus);
		} else {
			example.createCriteria();
		}
		return workOrderMapper.selectByExample(example);
	}

	public List<WorkOrder> selectYwOrderList(Integer memberId, Integer orderstatus) {
		WorkOrderExample example = new WorkOrderExample();
		example.setOrderByClause("create_time desc");
		if (orderstatus != null) {
			if (orderstatus.equals(Constants.OrderType.ORDER_HASPAY)) {
				List<Integer> list = new ArrayList<Integer>();
				list.add(Constants.OrderType.ORDER_HASPAY);
				list.add(Constants.OrderType.ORDER_DOING);
				list.add(Constants.OrderType.ORDER_TODONE);
				example.createCriteria().andMemberIdEqualTo(memberId).andOrderStatusIn(list);
			} else {
				example.createCriteria().andMemberIdEqualTo(memberId).andOrderStatusEqualTo(orderstatus);
			}
		} else {
			example.createCriteria().andMemberIdEqualTo(memberId);
		}
		List<WorkOrder> list = workOrderMapper.selectByExample(example);
		for (WorkOrder workOrder : list) {
			com.yhcrt.iHealthCloud.entity.Service service = serviceMapper.selectByPrimaryKey(workOrder.getServiceId());
			workOrder.setService(service);
		}
		return list;
	}

	@Override
	public String sendServiceOrder(JSONObject pdata) {
		// 获取参数
		JSONObject biz = pdata.getJSONObject("biz");
		String serviceid = biz.getString("service_id");
		String memberid = biz.getString("member_id");
		String servicetime = biz.getString("service_time");
		String openid = biz.getString("open_id");
		String addressid = biz.getString("address_id");
		String paytype = biz.getString("pay_type"); // small小程序 wechat 微信app
													// alipay支付宝 alipay_pc支付宝
		if (judgeAgumentsIsLegal(pdata, serviceid, memberid, paytype, addressid, servicetime)) {
			com.yhcrt.iHealthCloud.entity.Service service = serviceMapper.selectByPrimaryKey(Integer.valueOf(serviceid));
			Member member = memberMapper.selectByPrimaryKey(Integer.valueOf(memberid));
			MemberAddress address = memberAddressMapper.selectByPrimaryKey(Integer.valueOf(addressid));
			if (service != null && member != null) {
				WorkOrder workOrder = new WorkOrder();
				int orderId = sequenceService.getSequenceValue(Constants.SequenceName.WORK_ORDER);
				workOrder.setOrderId(orderId);
				workOrder.setServiceId(Integer.valueOf(serviceid));
				workOrder.setMemberId(Integer.valueOf(memberid));
				workOrder.setOrderContent(service.getServiceName());
				workOrder.setServiceObject(address.getRecipient());
				workOrder.setTel(address.getPhoneNum());
				workOrder.setAddress(address.getAddress());
				workOrder.setCreateTime(DateUtils.dateToString19(new Date()));
				workOrder.setOrderStatus(Constants.OrderType.ORDER_NOPAY); // 待支付
				workOrder.setStartTime(servicetime);
				workOrder.setUnitPrice(Double.valueOf(service.getUnitPrice()));
				workOrder.setAmount(1); // 默认数量1
				workOrder.setServiceFee(Double.valueOf(service.getUnitPrice()));
				workOrder.setDiscounts(0d);
				String orderNo = DateUtil.getOrderNo();
				workOrder.setCext1(orderNo);
				String orderNum = DateUtil.getTranNum();
				workOrder.setCext2(orderNum);
				// workOrder.setPayStatus(0); //此字段已被取消
				workOrder.setPayType(paytype);
				workOrderMapper.insertSelective(workOrder);
				// 调用支付接口
				JSONObject jsonParam = new JSONObject();
				jsonParam.put("orderId", orderNum);
				jsonParam.put("totalAmount", "0.01");
				jsonParam.put("body", service.getServiceName() + "购买");

				String url = "";
				switch (paytype) {
				case "small":
					url = RequestUtils.SMALL_URL;
					jsonParam.put("openid", openid);
					jsonParam.put("callback", RequestUtils.SMALL_NOTIFY);
					break;
				case "wechat":
					url = RequestUtils.WECHAT_URL;
					jsonParam.put("callback", RequestUtils.WECHAT_NOTIFY);
					break;
				case "alipay":
					url = RequestUtils.ALIPAY_URL;
					jsonParam.put("subject", service.getServiceName());
					jsonParam.put("callback", RequestUtils.ALIPAY_NOTIFY);
					break;
				case "alipay_pc":
					url = RequestUtils.ALIPAY_PC_URL;
					jsonParam.put("callback", "");
					break;
				default:
					break;
				}
				String resulstStr = RequestUtils.httpPostWithJson(jsonParam, url);
				if (!StringUtils.isEmpty(resulstStr)) {
					if ("small".equals(paytype) || "wechat".equals(paytype)) {
						JSONObject json = JSONObject.parseObject(resulstStr);
						json.put("order_num", orderNo);
						if ("small".equals(paytype)) {
							json.put("totalAmount", jsonParam.get("totalAmount"));
							json.put("createTime", workOrder.getCreateTime());
							json.put("accessToken", WxAppletUserInfo.getAccessToken().get("access_token"));
						}
						pdata.put(Const.TAG_BIZ, json);
					} else {
						pdata.put(Const.TAG_BIZ, resulstStr);
					}
					pdata.put(Const.TAG_STS, Const.TAG_STS_SUCCESS);
					pdata.put(Const.TAG_RMK, "获取成功");
				}
			} else {
				requestFailed(pdata, "缺少会员或服务信息");
			}
		} else {
			requestFailed(pdata, Const.RMK_BIZ_PARAM_NULL);
		}
		return pdata.toJSONString();
	}

	@Override
	public String payWorkorder(JSONObject pdata) {
		// 获取参数
		JSONObject biz = pdata.getJSONObject("biz");
		String orderNo = biz.getString("order_num");
		// 传给微信的交易订单单号
		String tranNum = DateUtil.getTranNum();
		String openid = biz.getString("open_id");
		WorkOrderExample example = new WorkOrderExample();
		example.createCriteria().andCext1EqualTo(orderNo);
		List<WorkOrder> empList = workOrderMapper.selectByExample(example);
		if (empList.size() != 1) {
			pdata.put(Const.TAG_STS, Const.TAG_STS_FAIL);
			pdata.put(Const.TAG_RMK, "该订单号有问题");
			return pdata.toJSONString();
		}
		WorkOrder workOrder = empList.get(0);
		if (workOrder.getOrderStatus() != null
				&& workOrder.getOrderStatus() > Constants.OrderType.ORDER_NOPAY) { // 不是待支付
			pdata.put(Const.TAG_STS, Const.TAG_STS_FAIL);
			pdata.put(Const.TAG_RMK, "该订单号已经支付");
			return pdata.toJSONString();
		}
		com.yhcrt.iHealthCloud.entity.Service service = serviceMapper.selectByPrimaryKey(Integer.valueOf(workOrder.getServiceId()));
		Member member = memberMapper.selectByPrimaryKey(Integer.valueOf(workOrder.getMemberId()));
		if (service != null && member != null) {
			// 调用支付接口
			String paytype = workOrder.getPayType();
			JSONObject jsonParam = new JSONObject();
			jsonParam.put("orderId", tranNum);
			jsonParam.put("totalAmount", "0.01");
			jsonParam.put("body", service.getServiceName() + "购买");

			String url = "";
			switch (paytype) {
			case "small":
				url = RequestUtils.SMALL_URL;
				jsonParam.put("openid", openid);
				jsonParam.put("callback", RequestUtils.SMALL_NOTIFY);
				break;
			case "wechat":
				url = RequestUtils.WECHAT_URL;
				jsonParam.put("callback", RequestUtils.WECHAT_NOTIFY);
				break;
			case "alipay":
				url = RequestUtils.ALIPAY_URL;
				jsonParam.put("subject", service.getServiceName());
				jsonParam.put("callback", RequestUtils.ALIPAY_NOTIFY);
				break;
			case "alipay_pc":
				url = RequestUtils.ALIPAY_PC_URL;
				jsonParam.put("callback", "");
				break;
			default:
				break;
			}
			String resulstStr = RequestUtils.httpPostWithJson(jsonParam, url);
			if (!StringUtils.isEmpty(resulstStr)) {
				if ("small".equals(paytype) || "wechat".equals(paytype)) {
					JSONObject json = JSONObject.parseObject(resulstStr);
					json.put("order_num", workOrder.getCext1());
					if ("small".equals(paytype)) {
						json.put("totalAmount", jsonParam.get("totalAmount"));
						json.put("createTime", workOrder.getCreateTime());
						json.put("accessToken", WxAppletUserInfo.getAccessToken().get("access_token"));
					}
					pdata.put(Const.TAG_BIZ, json);
				} else {
					pdata.put(Const.TAG_BIZ, resulstStr);
				}
				pdata.put(Const.TAG_STS, Const.TAG_STS_SUCCESS);
				pdata.put(Const.TAG_RMK, "获取成功");

				// 不管成功或失败修改 数据库交易单号
				workOrder.setCext2(tranNum);
				workOrderMapper.updateTranNum(workOrder);
			}
		} else {
			requestFailed(pdata, "缺少会员或服务信息");
		}
		return pdata.toJSONString();
	}

	@Override
	public WorkOrder getOrderInfo(Integer cid) {
		WorkOrder order = get(cid);
		com.yhcrt.iHealthCloud.entity.Service service = serviceMapper.selectByPrimaryKey(order.getServiceId());
		order.setService(service);
		return order;
	}

	@Override
	public void updateStatus(Integer cid, Integer orderStatus, String cext3) {
		WorkOrder order = new WorkOrder();
		order.setOrderId(cid);
		order.setOrderStatus(orderStatus);
		order.setCext3(cext3);
		workOrderMapper.updateByPrimaryKeySelective(order);
	}

	@Override
	public WorkOrder getByCext1(String cext1) {
		WorkOrderExample example = new WorkOrderExample();
		example.createCriteria().andCext1EqualTo(cext1);
		return workOrderMapper.selectByExample(example).size() > 0 ? workOrderMapper.selectByExample(example).get(0) : new WorkOrder();
	}

	@Override
	public void updateAddress(Integer cid, String serviceObject, String tel, String address) {
		WorkOrder order = new WorkOrder();
		order.setOrderId(cid);
		order.setServiceObject(serviceObject);
		order.setTel(tel);
		order.setAddress(address);
		workOrderMapper.updateByPrimaryKeySelective(order);

	}

	@Override
	@Transactional
	public void updateRefund(Integer orderid, Integer status, String refundtype, String content) {
		// 查询工单明细信息
		WorkOrder order = workOrderMapper.selectByPrimaryKey(orderid);
		if (order != null) {
			order.setOrderStatus(status);
			workOrderMapper.updateByPrimaryKey(order);
			// 新增退款表数据
			OrderRefund orderRefund = new OrderRefund();
			orderRefund.setRefId(order.getOrderId());
			orderRefund.setApplyTime(DateUtil.getDateTime());
			orderRefund.setRefundMoney(order.getActualPayment());
			orderRefund.setRefundType(refundtype);
			orderRefund.setRefundReson(content);
			orderRefund.setType(Constants.SERVICE);
			orderRefund.setStatus(status); // 表示退款中
			orderRefundMapper.insert(orderRefund);
		}
	}
	
	@Override
	public String uploadServiceLog(JSONObject jsonObject) {
		JSONObject bizObj = getBizObj(jsonObject);
		String orderId = bizObj.getString("order_id");
		String empId = bizObj.getString("emp_id");
		String serviceContent = bizObj.getString("service_content");
		String servciePic = bizObj.getString("service_pic");
		String serviceAddress = bizObj.getString("service_address");
		if (StringUtils.isBlank(orderId) || StringUtils.isBlank(empId)) {
			requestFailed(jsonObject, Const.RMK_BIZ_PARAM_NULL);
			return toJsonStringWithOutNull(jsonObject);
		}
		try {
			ServiceLog serviceLog = new ServiceLog();
			serviceLog.setOrderId(Integer.valueOf(orderId));
			serviceLog.setHandler(empId);
			serviceLog.setServiceContent(serviceContent);
			serviceLog.setCreateTime(DateUtils.getCurrentTime());
			serviceLog.setServiceAddress(serviceAddress);
			serviceLogMapper.insert(serviceLog);
			// 上传服务场景图
			servciePic = StringUtils.isNotBlank(servciePic) ? servciePic : "";
			String[] pics = servciePic.split(",");
			;
			for (String pic : pics) {
				YwImage image = new YwImage();
				image.setRefId(Integer.valueOf(orderId));
				image.setModuleCode("service_log");
				image.setImgPath(pic);
				image.setUploadTime(DateUtils.getCurrentTime());
				ywImageMapper.insert(image);
			}
			jsonObject.put(Const.TAG_STS, Const.TAG_STS_SUCCESS);
		} catch (Exception e) {
			requestFailed(jsonObject, Constants.ExceptionMsg.SERVER_ERROR);
			e.printStackTrace();
		}
		return toJsonStringWithOutNull(jsonObject);
	}

	@Override
	public String getServiceLogDetail(JSONObject jsonObject) {
		JSONObject bizObj = getBizObj(jsonObject);
		String orderId = bizObj.getString("order_id");
		try {
			OrderServiceLog orderServiceLog = workOrderMapper.getWorkOrderServiceLogDetail(Integer.valueOf(orderId));
			if (orderServiceLog != null) {
				YwImageExample example = new YwImageExample();
				example.createCriteria().andRefIdEqualTo(Integer.valueOf(orderId)).andModuleCodeEqualTo("service_log");
				List<YwImage> servicePic = ywImageMapper.selectByExample(example);
				orderServiceLog.setServicePic(servicePic);
				jsonObject.put(Const.TAG_STS, Const.TAG_STS_SUCCESS);
				jsonObject.put(Const.TAG_BIZ, orderServiceLog);
			} else {
				requestFailed(jsonObject, Constants.ExceptionMsg.ORDER_NOTFOUND);
			}

		} catch (Exception e) {
			requestFailed(jsonObject, Constants.ExceptionMsg.SERVER_ERROR);
			e.printStackTrace();
		}
		return toJsonStringWithOutNull(jsonObject);
	}

	@Override
	public String confirmCompleted(JSONObject jsonObject) {
		JSONObject bizObj = getBizObj(jsonObject);
		String orderId = bizObj.getString("order_id");
		try {
			WorkOrder workOrder = workOrderMapper.selectByPrimaryKey(Integer.valueOf(orderId));
			workOrder.setOrderStatus(Constants.WorkOrderStatus.COMPLETED);
			workOrderMapper.updateByPrimaryKeySelective(workOrder);
			jsonObject.put(Const.TAG_STS, Const.TAG_STS_SUCCESS);
		} catch (Exception e) {
			requestFailed(jsonObject, Constants.ExceptionMsg.SERVER_ERROR);
			e.printStackTrace();
		}
		return toJsonStringWithOutNull(jsonObject);
	}

	@Override
	public String getWorkOrderTraceDetail(JSONObject jsonObject) {
		JSONObject bizObj = getBizObj(jsonObject);
		String orderId = bizObj.getString("order_id");
		if (StringUtils.isBlank(orderId)) {
			requestFailed(jsonObject, Const.RMK_BIZ_PARAM_NULL);
			return toJsonStringWithOutNull(jsonObject);
		}
		WorkOrderTrace workOrderTrace = workOrderMapper.getWorkOrderTraceDetail(Integer.valueOf(orderId));
		jsonObject.put(Const.TAG_STS, Const.TAG_STS_SUCCESS);
		jsonObject.put(Const.TAG_BIZ, workOrderTrace);
		return toJsonStringWithOutNull(jsonObject);
	}

	@Override
	public String getOrgServicers(JSONObject jsonObject) {
		JSONObject bizObj = getBizObj(jsonObject);
		String orgId = bizObj.getString("org_id");
		if (StringUtils.isBlank(orgId)) {
			requestFailed(jsonObject, Const.RMK_BIZ_PARAM_NULL);
			return toJsonStringWithOutNull(jsonObject);
		}
		EmployeeExample example = new EmployeeExample();
		example.createCriteria().andOrgIdEqualTo(Integer.valueOf(orgId)).andSpecialtyEqualTo(Constants.EMP_SPECIALTY_SERVICER);
		List<OrgServicer> orgServicers = employeeMapper.getOrgServicersByExample(example);
		jsonObject.put(Const.TAG_STS, Const.TAG_STS_SUCCESS);
		jsonObject.put(Const.TAG_BIZ, orgServicers);
		return toJsonStringWithOutNull(jsonObject);
	}
}
